# Changelog

## [0.5] 2022-01-20

### Changed

- Fix calculation of called variant allele-frequencies.

  https://github.com/CSB5/lofreq/issues/80 means that lofreq-calculated AF
  values are lower bounds of true AFs when bases are excluded from calling
  based on base quality. The extent of AF underestimation depends on the
  fraction of bases with sub-threshold (30 for this workflow) base qualities.
  This version avoids the issue by running lofreq call twice: once with
  --min-bq 30 for obtaining variant calls, once with --min-bq 1 to obtain
  correctly calculated call stats for the variants. Calls and their stats are
  then merged using bcftools annotate.

- Simplify amplicon bias correction.

  After removal of biased amplicons, variants are recalled with --min-bq 1 to
  obtain updated call stats. These are then used to update the original list of
  variants using bcftools annotate, which simultaneously adds the AmpliconBias
  flag to variants that could not be recalled.

- Upgrade the Galaxy wrapper versions of ivar trim and ivar removereads.

  This makes it easy for users to calculate primer amplicon info from suitable
  primer scheme bed files instead of passing the info as a separate file.
  This workflow sticks to the previous behavior to avoid new requirements on
  primer names.

### Added

- Add a step to filter out failed datasets before flattening the Qualimap BamQC
  data for use by MultiQC.

  Qualimap BamQC fails on empty BAM input and trying to flatten the resulting
  collection containing failed datasets would cause the invocation of the
  workflow to fail.

## [0.4.2] 2021-12-13

### Added
- Added GitHub Actions workflow. No functional changes.

## [0.4.1] 2021-07-23

### Added

Added RO-Crate metadata file. No functional changes.

## [0.4] - 2021-06-16

### Changed

- Upgrade multiqc to 1.9+galaxy1

## [0.3] - 2021-05-19

### Changed

This version brings a number of tweaks to the ivar-dependent steps of the
workflow. Together, these are expected to make variant allele frequency
calculations more precise, in general, and robust in the face of an increasing
number of variants at primer binding sites:

- Upgrade ivar from version 1.2.2 to 1.3.1
  This affects ivar trim and ivar removereads
- Use the newly introduced -f option of ivar trim to exclude read pairs from
  further analysis that extend beyond amplicon boundaries.
  This change should be benefitial for accurate AF calculations in general,
  but in particular for corrected AF values after removal of biased amplicons,
  where aberrant read pairs often represent a larger fraction of the remaining
  reads.
- Run ivar trim only after realignment and addition of indel qualities by
  lofeq. This should make sure that indels close to primer sequences are
  seen as read-internal events.
- Turn the lower and upper thresholds for variant AF that triggers readremoval
  into workflow input parameters and adjust their defaults to trigger read
  removal only in more obvious cases of non-fixed variants.
- Require a minimum depth of coverage for recalled variants after read removal
  of 20 to ensure reliable AF values.
  This change also prevents situations where variants are recalled successfully
  after read removal, but are later excluded from variant reports generated by
  the reporting workflow due to that workflow's min_dp_alt >= 10 filter.

## [0.2]

### Changed

- Turn the AmpliconRemoval variant FILTER into an AmpliconBias INFO flag
- Apply the strand-bias filter only after variant annotation with snpEff. By
  producing fully annotated VCFs with and without filtering, downstream
  workflows can easily be switched between filtered/unfiltered input data

### Fixed

- Make sure the header information about the added flag gets propagated to the
  final VCF

## [0.1]

- Initial version of COVID-19: variation analysis on ARTIC PE data workflow
