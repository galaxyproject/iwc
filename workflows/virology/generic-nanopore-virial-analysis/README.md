# VirDetectorGalaxy

VirDetectorGalaxy is the Galaxy implementation of the original VirDetector pipeline.

This workflow is designed for virus surveillance using Oxford Nanopore long-read sequencing data. It enables virus detection, metagenomic analysis, phylogenetic analysis, and structural variant analysis.

## Description

VirDetectorGalaxy processes Nanopore sequencing reads to detect viral genomes and perform downstream analyses, including genome reconstruction and phylogenetic inference. The workflow supports both reference-based and hybrid approaches.

If no reference sequences are provided, the pipeline automatically performs a hybrid assembly step to identify a suitable reference genome.

## Inputs

### Required

- **Nanopore reads (FASTQ)**  
  A collection of FASTQ files containing Oxford Nanopore long-read sequencing data.  
  Other sequencing technologies are not supported and may cause the workflow to fail.

### Optional

- **Reference sequences**  
  A collection of reference genome sequences corresponding to the samples in the reads collection.

If the same reference genome is used for all samples, use the **“Duplicate file to collection”** tool to create a reference collection that matches the number of samples.  

- **Host species**
  The species from which the samples were obtained, used for decontamination.

- **Mapping profile**
  Specifies the sequencing platform (e.g., Nanopore, PacBio) used to map reads against the host genome.
  
- **Metagenomic analysis**  
  Boolean option (`yes` / `no`) to enable or disable metagenomic analysis.

- **Maximum Likelihood phylogeny**  
  Boolean option (`yes` / `no`) to enable or disable phylogenetic inference using maximum likelihood.

- **Bayesian phylogeny**  
  Boolean option (`yes` / `no`) to enable or disable phylogenetic inference using Bayesian inference.

## Workflow Behavior

- If reference sequences are provided, the workflow performs reference-based genome reconstruction.
- If no reference sequences are provided, the workflow performs a hybrid assembly to automatically determine a suitable reference genome.
- When phylogenetic analysis is enabled, all consensus genomes and selected database sequences are combined into a single multiple sequence alignment used to infer phylogenetic trees.
- If a host species is specified, a host decontamination step will be performed; otherwise, it will be skipped.

## Outputs

- **Read Quality (pre-trimming):** NanoComp report showing read quality before trimming.  
- **Read Quality (post-trimming):** NanoComp report showing read quality after trimming.  
- **Metagenomics Pie Chart (Krona):** Pie chart representing the percentage of detected species in the sample.  

### Genome Reconstruction
- **Mapping Alignment:** Final read alignment of each sample against the reference genome (either provided or de novo), generated with minimap2.  
- **Alignment Quality:** Summary of alignment metrics and quality.  
- **Viral Structure:** Sniffles report of detected viral structural variants.  
- **Best Organisms:** Top 5 hits for each sample.  
- **MSA:** Final multiple sequence alignment of all samples and reference genomes, including the top 5 BLAST hits per sample.  
- **Cleaned MSA:** MSA cleaned using CIAlign, with corresponding plot.  

### Phylogeny
- **IQ-TREE:** Phylogenetic tree generated by IQ-TREE; visualize by clicking the "Visualize" button and selecting the phylogenetic tree.  
- **MrBayes:** Report file including the posterior tree distribution.



## Debugging and Troubleshooting

If you encounter issues during workflow execution, follow these guidelines to identify and resolve common problems. Adjust parameters of the individual tools in the workflow to better suit your samples, and ensure that all inputs match the expected formats and requirements.

**Common issues and solutions:**

1. **Incorrect input format**  
   - Ensure that all input reads are in **FASTQ format**. Other formats (FASTA, BAM, POD5 etc.) may cause failures in preprocessing or downstream tools.
2. **Reads too short**  
   - Extremely short reads may be **trimmed or discarded** by preprocessing tools like Chopper. Check read length distributions and consider adjusting trimming thresholds before starting the workflow (this is discouraged).
3. **Insufficient read depth**  
   - Assemblers such as **Canu** require a minimum coverage to reconstruct genomes reliably. If reads are too few, the assembly step may fail. Consider increasing sequencing depth or using a different assembly strategy.
4. **Reference collection mismatch**  
   - For reference-based genome reconstruction, the **number of reference files must match the number of input samples**. Mismatched sizes can cause workflow failures, even if the same reference is repeated (you can use the tool **duplicate file to collection**).
5. **Tool parameter tuning**  
   - Many tools in the workflow allow customization of parameters (e.g., trimming length, k-mer sizes, mapping sensitivity). Adjust these parameters carefully to match your dataset characteristics, and look at individual tool documentation if needed.

**General tips:**
-⚠️ Always verify that input files are complete and correctly formatted.
-⚠️ Check workflow logs for errors and trace which step failed.
